name: "Bump version and create release"
description: "Bumps version, creates a tag, and publishes a release."

inputs:
  github_token:
    description: "GitHub token for authentication"
    required: true

outputs:
  tag:
    description: 'A new tag'
    value: ${% raw %}{{ steps.tag_version.outputs.new_tag }}{% endraw %}

runs:
  using: "composite"
  steps:
    # -----------------------------------------------------------------------------
    # Step 1: Bump version and tag
    # -----------------------------------------------------------------------------
    - name: Bump version and tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.2
      with:
        github_token: ${% raw %}${{ inputs.github_token }}{% endraw %}

    # -----------------------------------------------------------------------------
    # Step 2: Create GitHub release
    # -----------------------------------------------------------------------------
    - name: Create GitHub release without artifacts
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${% raw %}${{ steps.tag_version.outputs.new_tag }}{% endraw %}
        generate_release_notes: true

    - name: Debug Output Tag
      shell: bash
      run: |
          echo "DEBUG: ${% raw %}${{ steps.tag_version.outputs.new_tag }}{% endraw %}"

    # -----------------------------------------------------------------------------
    # Step 3: (optional) build DockerImage
    # -----------------------------------------------------------------------------
{% if use_docker %}
    - name: Install podman
      shell: bash
      run: |
        sudo apt-get update -qq
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y podman

    - name: Login to GitHub container registry
      shell: bash
      run: |
        podman login ghcr.io -u ${% raw %${{ github.actor }}{% endraw %} -p ${% raw %${{ inputs.github_token }}{% endraw %}
{% endif %}
